# تخزين الكاش
proxy_cache_path /var/cache/nginx/api_cache levels=1:2 keys_zone=api_cache:100m
                 inactive=30m max_size=2g use_temp_path=off;

server {
  listen 80 default_server;
  server_name _ localhost 192.168.1.45;

  # اختبار سريع
  location /test {
    add_header Content-Type text/plain;
    return 200 "Nginx OK\n";
  }

  # توجيه الفرونت React
  location / {
    proxy_pass http://frontend:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # استثناء مسارات المصادقة من الكاش
  location ~* ^/api/(auth|login|logout|user|profile|sanctum) {
    proxy_pass http://backend:8000;
    proxy_buffering off;
    proxy_no_cache 1;
    proxy_cache_bypass 1;
  }

  # باقي /api مع الكاش
  location ^~ /api/ {
    proxy_pass http://backend:8000;

    # مهلات معقولة
    proxy_connect_timeout 5s;
    proxy_send_timeout    30s;
    proxy_read_timeout    30s;

    # الكاش فقط لطلبات GET/HEAD وبلا Auth/Cookie
    set $no_cache 1;
    if ($request_method ~ ^(GET|HEAD)$) { set $no_cache 0; }
    if ($http_authorization) { set $no_cache 1; }
    if ($http_cookie)        { set $no_cache 1; }

    proxy_cache            api_cache;
    proxy_cache_key        $scheme$proxy_host$uri$is_args$args;
    proxy_no_cache         $no_cache;
    proxy_cache_bypass     $no_cache;

    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404       1m;
    proxy_cache_valid 500 502 503 504 1m;

    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;

    add_header X-Cache $upstream_cache_status always;
  }
}
